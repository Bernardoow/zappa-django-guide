<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Core django setup - My Docs</title>
        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
	
	<script src="../js/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/highlight.pack.js"></script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="..">My Docs</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                    <li >
                        <a href="..">Home</a>
                    </li>
                    <li class="active">
                        <a href="./">Core django setup</a>
                    </li>
                    <li >
                        <a href="../static_files/">Static files</a>
                    </li>
                </ul>

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                    <li >
                        <a rel="next" href="..">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../static_files/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#core-django-setup">Core Django Setup</a></li>
            <li><a href="#setup-and-prerequisites">Setup and Prerequisites</a></li>
            <li><a href="#walkthrough">Walkthrough</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="core-django-setup">Core Django Setup</h1>
<p>This section documents setting up a Django project with only core Python functionality responding to HTTP calls.  After this section the following will work:</p>
<ul>
<li>URL Routes</li>
<li>Views (but no static file serving)</li>
<li>Management Commands</li>
</ul>
<p>What will not work:</p>
<ul>
<li>Static Files not being served</li>
<li>There is no database connection available (not even SQLite)</li>
<li>No HTTPS support</li>
</ul>
<h2 id="setup-and-prerequisites">Setup and Prerequisites</h2>
<ul>
<li>Python 2.7 (due to <a href="http://docs.aws.amazon.com/lambda/latest/dg/current-supported-versions.html">AWS lambda only supporting 2.7</a>) </li>
<li>Django 1.10.4</li>
<li><a href="https://pypi.python.org/pypi/zappa">zappa 0.32.1</a></li>
</ul>
<h2 id="walkthrough">Walkthrough</h2>
<h3 id="setup-aws-account-credentials">Setup AWS Account Credentials</h3>
<p>Details in this section are light because this information is documented well elsewhere on the web.</p>
<ul>
<li>Create AWS Account if you haven't already</li>
<li>Create an S3 bucket.<br />
   For purposes of this walkthrough I have used the bucket name of <code>zappatest-code</code> in the 'US Standard' region.  This bucket will be used by zappa as a mechanism to upload your project into the lambda environment.  Thus it will generally be empty except during the brief time you are deploying the project.</li>
<li>Create an IAM User with API keys
   Easier said than done.  The quick and easy way of doing this is to create a user with a policy that allows a very broad set of permissions.  However, this is not great from a security perspective. There is an <a href="https://github.com/Miserlou/Zappa/issues/244">ongoing discussion</a> about the exact set of permissions needed.</li>
</ul>
<p>Now we need to allow scripts and local programs to get the credentials created above.  You have some options for this:</p>
<ol>
<li>Set <a href="https://github.com/Miserlou/Zappa/issues/244">environment variables</a></li>
</ol>
<p>This is very easy but must be done for each bash console you are using.</p>
<p><code>export AWS_ACCESS_KEY_ID=&lt;your key here&gt;
   export AWS_SECRET_ACCESS_KEY=&lt;your secret access key here&gt;</code>
2. Create a local credentials file (<code>~/.aws/credentials</code> on Linux, or OS X)</p>
<pre><code>Probably a better long term solution since you can store multiple 
sets of keys for different environments using profiles.
</code></pre>
<p><code>[default]
   aws_access_key_id = your_access_key_id
   aws_secret_access_key = your_secret_access_key</code></p>
<p>Useful links for Windows or more information:</p>
<ul>
<li>http://docs.aws.amazon.com/sdk-for-java/v1/developer-guide/setup-credentials.html</li>
<li>http://boto3.readthedocs.io/en/latest/guide/configuration.html#configuring-credentials</li>
</ul>
<h3 id="create-local-environment">Create local environment</h3>
<p>It is highly recommended that you leverage virtual environments for this test project.</p>
<pre><code>mkdir zappatest
cd zappatest
virtualenv ve
source ve/bin/activate
pip install django zappa
</code></pre>

<h3 id="create-very-basic-django-project">Create very basic Django project</h3>
<p>For the purposes of this walkthrough we are taking the most basic Django project.</p>
<pre><code>django-admin startproject frankie .
</code></pre>

<h4 id="testing-the-basic-django-project">Testing the basic Django project</h4>
<p>At this point if you run </p>
<pre><code>python manage.py runserver
</code></pre>

<p>And visit http://127.0.0.1:8000 with your browser you should see the standard Django 'It Worked!' page</p>
<p>Now quit the server using Control-C.  You should be back at the console prompt</p>
<h3 id="setup-zappa">Setup Zappa</h3>
<pre><code>zappa init
</code></pre>

<p>You will encounter a series of prompts:</p>
<ul>
<li>Name of environment - just accept the default 'dev'</li>
<li>S3 bucket for deployments.  Use the value of the S3 bucket you created above.  If you follow the walkthrough then use <code>zappatest-code</code></li>
<li>Zappa should automatically find the correct settings file so accept the default</li>
<li>Say 'no' to deploying globally</li>
<li>If everything looks ok, then accept the info</li>
</ul>
<p>Here's a transcript of what you should see:</p>
<pre><code>(ve) $ zappa init

███████╗ █████╗ ██████╗ ██████╗  █████╗
╚══███╔╝██╔══██╗██╔══██╗██╔══██╗██╔══██╗
  ███╔╝ ███████║██████╔╝██████╔╝███████║
 ███╔╝  ██╔══██║██╔═══╝ ██╔═══╝ ██╔══██║
███████╗██║  ██║██║     ██║     ██║  ██║
╚══════╝╚═╝  ╚═╝╚═╝     ╚═╝     ╚═╝  ╚═╝

Welcome to Zappa!

Zappa is a system for running server-less Python web applications on AWS Lambda and AWS API Gateway.
This `init` command will help you create and configure your new Zappa deployment.
Let's get started!

Your Zappa configuration can support multiple production environments, like 'dev', 'staging', and 'production'.
What do you want to call this environment (default 'dev'):

Your Zappa deployments will need to be uploaded to a private S3 bucket.
If you don't have a bucket yet, we'll create one for you too.
What do you want call your bucket? (default 'zappa-v20ssav8g'): zappatest-code

It looks like this is a Django application!
What is the module path to your projects's Django settings?
We discovered: frankie.settings
Where are your project's settings? (default 'frankie.settings'):

You can optionally deploy to all available regions in order to provide fast global service.
If you are using Zappa for the first time, you probably don't want to do this!
Would you like to deploy this application to globally? (default 'n') [y/n/(p)rimary]: n

Okay, here's your zappa_settings.js:

{
    &quot;dev&quot;: {
        &quot;django_settings&quot;: &quot;frankie.settings&quot;,
        &quot;s3_bucket&quot;: &quot;zappatest-code&quot;
    }
}

Does this look okay? (default 'y') [y/n]: y

Done! Now you can deploy your Zappa application by executing:

    $ zappa deploy dev

After that, you can update your application code with:

    $ zappa update dev

To learn more, check out our project page on GitHub here: https://github.com/Miserlou/Zappa
and stop by our Slack channel here: http://bit.do/zappa

Enjoy!,
 ~ Team Zappa!
(ve) $
</code></pre>

<h4 id="testing-the-zappa-setup">Testing the Zappa Setup</h4>
<p>So now if we run</p>
<pre><code>zappa deploy dev
</code></pre>

<p>But unfortunately we encounter an error: </p>
<pre><code>(ve) $ zappa deploy dev
Calling deploy for environment dev..
Warning! AWS Lambda may not be available in this AWS Region!
Warning! AWS API Gateway may not be available in this AWS Region!
Oh no! An error occurred! :(

==============

Traceback (most recent call last):
    [boring callback removed]
NoRegionError: You must specify a region.

==============

Need help? Found a bug? Let us know! :D
File bug reports on GitHub here: https://github.com/Miserlou/Zappa
And join our Slack channel here: https://slack.zappa.io
Love!,
 ~ Team Zappa!
(ve) $
</code></pre>

<p>Aw man, the error <strong>NoRegionError: You must specify a region.</strong> is holding us back.  Zappa is complaining that no AWS region is specified.  So we need to specify a region.  In this walkthrough we are leveraging <code>us-east-1</code> which corresponds to the same region we used above for the S3 bucket.</p>
<p>You have options:</p>
<ol>
<li>Specify a default region using environment variables</li>
</ol>
<p>Again, the drawback here is this must be set for every console</p>
<p><code>export AWS_DEFAULT_REGION=us-east-1</code>
2. Add default region in your <code>~/.awd/credentials</code> file</p>
<pre><code>Better but this will affect all AWS scripts and programs on your machine.
</code></pre>
<p><code>[default]
   aws_access_key_id = your_access_key_id
   aws_secret_access_key = your_secret_access_key
   region=us-east-1</code></p>
<ol>
<li>Edit the <code>zappa_settings.json</code> file to have an AWS region.</li>
</ol>
<p>Probably best option because now the zappa configuration has minimal dependencies on external user environment.</p>
<p><code>{
    "dev": {
        "aws_region": "us-east-1",
        "django_settings": "frankie.settings",
        "s3_bucket": "zappatest-code"
        }
    }</code>
    Don't forget to put commas in the proper place - JSON is fiddly!</p>
<h3 id="deploy-your-project-using-zappa">Deploy your project using Zappa</h3>
<p>Now it's easy to do the initial deployment</p>
<pre><code>zappa deploy dev
</code></pre>

<p>Zappa will automatically create an AWS API gateway that will route HTTP requests to your lambda Django project.  You should see something like:</p>
<pre><code>(ve) $ zappa deploy dev
Calling deploy for environment dev..
Downloading and installing dependencies..
100%|███████████████████████████████████████████████████████████████████████████████████████████| 27/27 [00:07&lt;00:00,  3.91pkg/s]
Packaging project as zip..
Uploading zappatest-dev-1482425936.zip (13.1MiB)..
100%|████████████████████████████████████████████████████████████████████████████████████████| 13.8M/13.8M [00:25&lt;00:00, 603KB/s]
Scheduling..
Scheduled zappatest-dev-zappa-keep-warm-handler.keep_warm_callback!
Uploading zappatest-dev-template-1482425980.json (1.5KiB)..
100%|███████████████████████████████████████████████████████████████████████████████████████| 1.58K/1.58K [00:00&lt;00:00, 2.08KB/s]
Waiting for stack zappatest-dev to create (this can take a bit)..
100%|█████████████████████████████████████████████████████████████████████████████████████████████| 4/4 [00:18&lt;00:00,  4.69s/res]
Deploying API Gateway..
Deployment complete!: https://x6kb437rh.execute-api.us-east-1.amazonaws.com/dev
</code></pre>

<p>Brilliant!  We should be able to use a browser to visit the URL provided at the end of the script.</p>
<p>Once we do, however, we get:</p>
<pre><code>DisallowedHost at /
Invalid HTTP_HOST header: 'x6kb437rh.execute-api.us-east-1.amazonaws.com'. 
You may need to add x6kb437rh.execute-api.us-east-1.amazonaws.com' to ALLOWED_HOSTS.
</code></pre>

<p>The built-in <a href="https://docs.djangoproject.com/en/1.10/topics/security/#host-header-validation">Django security settings</a> are kicking in and preventing bad stuff from happening.  So we need to modify our Django settings file to accommodate the <a href="http://docs.aws.amazon.com/apigateway/latest/developerguide/how-to-custom-domains.html">default hostname that AWS API Gateway uses</a>.  Note that the AWS region is part of the hostname and thus should match your selected region.</p>
<p>Now edit <code>frankie/settings.py</code> and change ALLOWED_HOSTS to;</p>
<pre><code>ALLOWED_HOSTS = [ '127.0.0.1', '.execute-api.us-east-1.amazonaws.com', ]
</code></pre>

<p>Once done, we can again deploy to AWS Lambda.  But this time, since we've already pushed the initial deploy, we use the <strong>update</strong> action on the zappa command line.</p>
<pre><code>zappa update dev
</code></pre>

<p>After this completes, you should be able to see your Django site in action.  Note that you will actually get a Page not found (404) response.  This indicates that your Django site is functional and working.   </p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>var base_url = '..';</script>
        <script data-main="../mkdocs/js/search.js" src="../mkdocs/js/require.js"></script>
        <script src="../js/base.js"></script><div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
