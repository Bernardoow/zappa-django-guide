<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Using a Database - Guide to using Django with Zappa</title>
        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
	
	<script src="../js/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/highlight.pack.js"></script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="..">Guide to using Django with Zappa</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                    <li >
                        <a href="..">Home</a>
                    </li>
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Walkthroughs <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../setup/">Setup your Environment</a>
</li>
                            
<li >
    <a href="../walk_core/">Core Django Setup</a>
</li>
                            
<li >
    <a href="../walk_static/">Hosting Static Files</a>
</li>
                            
<li class="active">
    <a href="./">Using a Database</a>
</li>
                            
<li >
    <a href="../walk_cdn/">You need a CDN</a>
</li>
                            
<li >
    <a href="../walk_https/">Secure HTTPS</a>
</li>
                            
<li >
    <a href="../walk_media/">Wrangling Media Files</a>
</li>
                            
<li >
    <a href="../walk_scheduling/">Tasks and Events</a>
</li>
                            
<li >
    <a href="../walk_debug/">Debugging</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">AWS Setup <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../aws_credentials/">Managing Credentials</a>
</li>
                            
<li >
    <a href="../aws_network/">Adventures in Networking</a>
</li>
                            
<li >
    <a href="../aws_database/">Creating an RDS Database</a>
</li>
                        </ul>
                    </li>
                    <li >
                        <a href="../additional/">Additional</a>
                    </li>
                </ul>

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                    <li >
                        <a rel="next" href="../walk_static/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../walk_cdn/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#using-a-database">Using a Database</a></li>
            <li><a href="#prerequisites">Prerequisites</a></li>
            <li><a href="#options-for-databases">Options for Databases</a></li>
            <li><a href="#create-your-rds-database">Create your RDS Database</a></li>
            <li><a href="#setup-your-configuration">Setup your Configuration</a></li>
            <li><a href="#create-your-database">Create your Database</a></li>
            <li><a href="#init-the-database">Init the Database</a></li>
            <li><a href="#create-your-django-superuser">Create your Django superuser</a></li>
            <li><a href="#test-and-profit">Test and profit</a></li>
        <li class="main "><a href="#further-topics">Further Topics</a></li>
            <li><a href="#security">Security</a></li>
            <li><a href="#additional-references">Additional References</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="using-a-database">Using a Database</h1>
<p>This walkthough documents the steps necessary to connect your application to a hosted database.</p>
<h2 id="prerequisites">Prerequisites</h2>
<p>This walkthough requires the (Core Django Setup)[walk_core.md] to be completed.  Also, it is important 
to have your network setup properly so check out (Adventures in Networking)[aws_network.md].  </p>
<p>We will assume you have chosen the VPC pattern: "VPC with a Public subnet and Private subnet"
But basically you will need the private subnet or subnets which can access the database.</p>
<h2 id="options-for-databases">Options for Databases</h2>
<h3 id="use-aws-rds">Use AWS RDS</h3>
<p>This is probably the easiest to get up and running.  AWS takes care of the messy details of managing the host and provides database-as-a-service (if that's a real thing).  In addition, AWS RDS supports mySQL and PostGreSQL, both which are highly compatible with Django.  </p>
<h3 id="host-your-own">Host Your Own</h3>
<p>Of course you can be running any type of database on an EC2 instance of your choosing.  Usually an EC2 instance will be associated with one subnet, but it is possible to have multiple IP addresses in different subnets for redundancy.</p>
<h3 id="use-another-db-service">Use another DB Service</h3>
<p>There as some other database services such as DynamoDB.  Depending on the capabilities of the service, you may or may need the subnet information.  </p>
<h2 id="create-your-rds-database">Create your RDS Database</h2>
<p>We'll just focus on the RDS case for this walkthough.  In fact we'll go through the walkthough using PostGreSQL.</p>
<p>So zip on over to <a href="../aws_database/">Creating an RDS Database</a> and set up one.  You should record some key information we'll need here:</p>
<ul>
<li>The subnets (there should be at least two) in which we can access the database</li>
<li>The endpoint (hostname) of the database and the port</li>
<li>The username and password for the root user</li>
</ul>
<p>Note that at this point you don't yet have a database installed on your RDS instance.  So let's just pick a name we will use for the walkthough.  </p>
<p>Here is our sample data:</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Sample value</th>
</tr>
</thead>
<tbody>
<tr>
<td>subnets</td>
<td>subnet-f3446aba, subnet-c5b8c79e</td>
</tr>
<tr>
<td>endpoint</td>
<td>zappa-db.crt239fsjdlk.us-east-1.rds.amazonaws.com</td>
</tr>
<tr>
<td>db username</td>
<td>administrator</td>
</tr>
<tr>
<td>db password</td>
<td>this_is_not_a_good_password</td>
</tr>
<tr>
<td>db name</td>
<td>zappadbname</td>
</tr>
</tbody>
</table>
<h2 id="setup-your-configuration">Setup your Configuration</h2>
<h3 id="edit-requirements">Edit requirements</h3>
<p>Note on PostGreSQL: because the psycopg2 library often involves compiling the library, I would suggest using the <a href="../setup/#approach-2-docker-with-zappa">Docker version of zappa</a> to ensure you have isolation of environments and you don't mess up your local system.</p>
<p>Add this to your requirements.txt 
<pre><code class="sh">psycopg2
</code></pre></p>
<p>and then</p>
<pre><code class="sh">pip install -r requirements
</code></pre>

<h3 id="django-settings">Django Settings</h3>
<p>Add the above settings to your settings.py</p>
<pre><code>DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql_psycopg2',
        'NAME': 'zappadbname',
        'USER': 'administrator',
        'PASSWORD': 'this_is_not_a_good_password',
        'HOST': 'zappa-db.crt239fsjdlk.us-east-1.rds.amazonaws.com',
        'PORT': '5432',
    }

}
</code></pre>

<h3 id="zappa-settings">Zappa Settings</h3>
<pre><code>{
    &quot;dev&quot;: {
        &quot;django_settings&quot;: &quot;frankie.settings&quot;, 
        &quot;s3_bucket&quot;: &quot;zappatest-code&quot;,
        &quot;aws_region&quot;: &quot;us-east-1&quot;,
        &quot;vpc_config&quot; : {
            &quot;SubnetIds&quot;: [ &quot;subnet-f3446aba&quot;,&quot;subnet-c5b8c79e&quot; ], // use the private subnet
            &quot;SecurityGroupIds&quot;: [ &quot;sg-9a9a1dfc&quot; ]
        }
    }
}
</code></pre>

<h2 id="create-your-database">Create your Database</h2>
<p>Ok, easy so far?  Yes!  All we had to do up to this point was carefully click a mouse in the AWS console and 
edit some text files.  Well fun time is over - now we run into some bootstrapping problems.  Fortunately, we only have to do this once each time we need a new database.</p>
<p>Turns out that when AWS creates a PostGreSQL RDS instance for you, it doesn't create a database.  So you have to do it yourself.  There are many options, but two methods could be:</p>
<ol>
<li>Use a db tool on your local machine via a bastion host </li>
<li>Use the AWS command line tool</li>
<li>Write some code to setup the database using zappa</li>
</ol>
<p>Option 1 is easy if you have the db tool and the bastion host setup.  But let's explore how to do options two and three.</p>
<h3 id="using-aws-command-line-tool">Using AWS command line tool</h3>
<p>You can only use the AWS command line tool to create the database if you are also creating the entire RDS instance.  Be sure to identify the database name to create with '<a href="http://docs.aws.amazon.com/cli/latest/reference/rds/create-db-instance.html#options">db-name</a>'</p>
<p>Simply use the <code>aws</code> command tool using syntax similar to
<a href="http://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_CreateInstance.html#USER_CreateInstance.CLI">http://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_CreateInstance.html#USER_CreateInstance.CLI</a></p>
<h3 id="setup-the-database-using-zappa">Setup the Database using zappa</h3>
<p>Well, there is no easy way to get this done but here is a possible option: create a management command that can be run in the zappa environment.  </p>
<h4 id="create-a-management-command-in-your-django-project">Create a management command in your Django Project</h4>
<p>Follow these steps to create a management command environment (make sure your virtualenv is fired up)</p>
<pre><code class="sh">cd frankie
python manage.py startapp axe
cd axe
mkdir management
cd management
touch __init.py__
mkdir commands
cd commands
touch __init.py__
</code></pre>

<p>Then create a file called <code>create_db.py</code></p>
<pre><code class="python">from psycopg2 import connect
from psycopg2.extensions import ISOLATION_LEVEL_AUTOCOMMIT
from django.core.management.base import BaseCommand, CommandError
from django.conf import settings

class Command(BaseCommand):
    help = 'Creates the initial database'

    def handle(self, *args, **options):
        self.stdout.write(self.style.SUCCESS('Starting db creation'))

        dbname = settings.DATABASES['default']['NAME']
        user = settings.DATABASES['default']['USER']
        password = settings.DATABASES['default']['PASSWORD']
        host = settings.DATABASES['default']['HOST']

        con = None
        con = connect(dbname='postgres', user=user, host = host, password=password)
        dbname = dbname
        con.set_isolation_level(ISOLATION_LEVEL_AUTOCOMMIT)
        cur = con.cursor()
        cur.execute('CREATE DATABASE ' + dbname)
        cur.close()
        con.close()

        self.stdout.write(self.style.SUCCESS('All Done'))
</code></pre>

<h4 id="run-the-management-command">Run the management command</h4>
<pre><code class="sh">zappa dev manage create_db
</code></pre>

<p>If all goes well, then your database should be created.</p>
<h2 id="init-the-database">Init the Database</h2>
<p>At this point you should have an empty database ready for your Django application to fill up with schema. If this were a traditional server, you would merely run the <code>migrate</code> command.  But you can't because there is no command line.  Thus we have to modify them to adjust to the new environment.</p>
<p>So create your migrations and push the updated code.  </p>
<p><pre><code class="sh">python manage.py makemigrations
zappa update dev
</code></pre>
Now you invoke the zappa manage command:</p>
<pre><code class="sh">zappa manage dev migrate
</code></pre>

<p>And repeat this process everytime you make model changes.</p>
<h2 id="create-your-django-superuser">Create your Django superuser</h2>
<p>The Django management commands were meant to be run interactively on a command line on a traditional server.  Because there is no command line with lambda, we must do some trickery to get around the input needed for the Django createsuperuser management command.</p>
<p>Essentially we will use the <code>raw</code> flag on the invoke command to just run raw python.  The following command creates a new superuser named 'admin' with email 'admin@yourdomain.com' and password of 'horse battery stapler'</p>
<pre><code class="sh">zappa invoke --raw dev &quot;from django.contrib.auth.models import User; User.objects.create_superuser('admin', 'admin@yourdomain.com', 'horse battery stapler')&quot;
</code></pre>

<p>Additional superusers can be added via this method or the Django admin console.</p>
<h2 id="test-and-profit">Test and profit</h2>
<p>At this point you should be able to log into your Django admin:
<img alt="Database FTW" src="../images/db_success.png" /></p>
<p>(http://marcelog.github.io/articles/aws_lambda_internet_vpc.html)</p>
<p>[https://www.isc.upenn.edu/accessing-mysql-databases-aws-python-lambda-function]</p>
<h1 id="further-topics">Further Topics</h1>
<h2 id="security">Security</h2>
<p>Notice that we are using the master user credentials for the RDS system.  It would be more secure if we created a dedicated user that can only access the relevant database.  More information on that can be found here:
<a href="https://www.digitalocean.com/community/tutorials/how-to-use-postgresql-with-your-django-application-on-ubuntu-14-04">https://www.digitalocean.com/community/tutorials/how-to-use-postgresql-with-your-django-application-on-ubuntu-14-04</a></p>
<p>You will have to modify your custom Django management command to accommodate creation of a new user.</p>
<h2 id="additional-references">Additional References</h2>
<p>For MySQL tips:
<a href="https://www.digitalocean.com/community/tutorials/how-to-use-postgresql-with-your-django-application-on-ubuntu-14-04">https://www.digitalocean.com/community/tutorials/how-to-use-postgresql-with-your-django-application-on-ubuntu-14-04</a></p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>var base_url = '..';</script>
        <script data-main="../mkdocs/js/search.js" src="../mkdocs/js/require.js"></script>
        <script src="../js/base.js"></script><div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
